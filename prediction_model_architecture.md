# 競馬予測モデルのアーキテクチャ設計

## 1. 機械学習アプローチの選定

### 1.1 教師あり学習と教師なし学習の比較

競馬予測には主に**教師あり学習**が適しています。教師あり学習では、特徴ベクトル（馬の情報、騎手情報など）と応答変数（着順、タイムなど）の関係を学習します。教師なし学習（クラスタリングなど）は直接予測には使用しませんが、データの前処理や特徴量エンジニアリングの補助として活用できます。

### 1.2 分類問題と回帰問題の比較

競馬予測では以下の問題設定が可能です：

#### 分類問題
- 1着かどうかの予測（二値分類）
- 複勝圏内かどうかの予測（二値分類）
- 1着からの着差が0.1秒以内かどうかの予測（二値分類）
- 1着/2着/3着/着外の予測（多クラス分類）
- 着順上位(1~3着)/中位(4~7着)/下位(8~)の予測（多クラス分類）

#### 回帰問題
- 走破タイムの予測
- 走破速度の予測
- スピード指数の予測
- 着順の予測（実数値として）

**選定理由**: 初期段階では複勝圏内予測（二値分類）と着順予測（多クラス分類）の両方を実装し、性能を比較します。クラスラベルの不均衡に注意し、特に1着予測のような極端に不均衡なケースは避けます。

### 1.3 推奨アルゴリズム

以下のアルゴリズムを検討します：

1. **LightGBM**（主要アルゴリズム）
   - 勾配ブースティング決定木（GBDT）ベース
   - 高速な学習速度とメモリ効率
   - 大規模データセットでも高精度
   - 特徴量の重要度を自動計算
   - ランキング学習にも対応

2. **XGBoost**（代替アルゴリズム）
   - GBDTベースで高精度
   - 過学習に強い正則化機能

3. **ランダムフォレスト**（ベースラインモデル）
   - 複数の決定木による安定した予測
   - パラメータ調整が比較的容易

4. **ニューラルネットワーク**（高度なモデル）
   - 複雑なパターン認識に強い
   - 大量のデータが必要
   - 計算コストが高い

**選定理由**: LightGBMを主要アルゴリズムとして採用します。競馬データのような構造化データに対して高い性能を発揮し、学習速度が速く、特徴量の重要度分析も容易です。また、ランキング学習機能を活用することで、レース内での馬の相対的な順位予測も可能です。

## 2. 特徴量エンジニアリング計画

### 2.1 基本特徴量

以下の基本特徴量を使用します：

#### 馬に関する特徴量
- 年齢、性別
- 馬体重、馬体重の変化
- 過去のレース成績（着順、タイム）
- 休養期間
- 血統情報（父馬、母馬）
- 調教タイム

#### 騎手に関する特徴量
- 勝率、連対率
- 特定コースでの成績
- 特定馬場状態での成績
- 特定距離での成績

#### レースに関する特徴量
- コース（芝/ダート）
- 距離
- 馬場状態
- 天候
- 開催場所
- レースのグレード
- 出走頭数

### 2.2 高度な特徴量

以下の高度な特徴量を生成します：

#### 時系列特徴量
- 直近3レースの平均着順
- 直近3レースの平均タイム
- 直近のレースからの経過日数
- 成績の上昇/下降トレンド

#### 相対的特徴量
- 同一レース内での馬体重の相対値
- 同一レース内での過去成績の相対値
- 同一レース内での騎手成績の相対値

#### 交互作用特徴量
- 騎手と馬の相性（過去の組み合わせ成績）
- 馬と特定コースの相性
- 馬と距離の相性

#### 外部データに基づく特徴量
- 人気指数（オッズ情報）
- 専門家予想
- SNSでの言及度（可能であれば）

### 2.3 特徴量選択手法

以下の特徴量選択手法を適用します：

1. **特徴量重要度に基づく選択**
   - LightGBMの特徴量重要度スコアを活用
   - 重要度の低い特徴量を除外

2. **相関分析**
   - 高い相関を持つ特徴量間で冗長性を排除

3. **L1正則化（Lasso）**
   - スパース解を促進し、不要な特徴量を自動的に0に

4. **交差検証による検証**
   - 特徴量の追加/削除による性能変化を評価

## 3. モデル評価指標

### 3.1 分類モデルの評価指標

- **正確度（Accuracy）**: 全体的な予測精度
- **適合率（Precision）**: 陽性と予測したもののうち、実際に陽性である割合
- **再現率（Recall）**: 実際の陽性のうち、陽性と予測できた割合
- **F1スコア**: 適合率と再現率の調和平均
- **ROC-AUC**: 二値分類の性能評価
- **混同行列（Confusion Matrix）**: 予測と実際のクラスの関係を視覚化

### 3.2 回帰モデルの評価指標

- **平均二乗誤差（MSE）**: 予測値と実際の値の差の二乗の平均
- **平均絶対誤差（MAE）**: 予測値と実際の値の絶対差の平均
- **決定係数（R²）**: モデルの説明力を示す指標

### 3.3 競馬特有の評価指標

- **的中率**: 予測上位N頭に実際の1着馬が含まれる割合
- **複勝的中率**: 予測上位N頭に実際の3着以内の馬が含まれる割合
- **回収率**: 予測に基づいて馬券を購入した場合の投資回収率
- **回収率の標準偏差**: 回収率の安定性を評価

## 4. モデル検証方法

### 4.1 データ分割

- **時系列分割**: 過去のデータで学習し、未来のデータでテスト
  - 訓練データ: 2015年〜2023年
  - 検証データ: 2024年前半
  - テストデータ: 2024年後半

### 4.2 交差検証

- **時系列交差検証**: 時系列データの特性を考慮した交差検証
  - 例: 2015-2022年のデータで学習し、2023年のデータで検証
  - 時間的依存性を考慮

### 4.3 ハイパーパラメータチューニング

以下のパラメータを最適化します：

#### LightGBM主要パラメータ
- `learning_rate`: 学習率
- `max_depth`: 木の最大深さ
- `num_leaves`: 葉の数
- `min_data_in_leaf`: 葉ノードに必要な最小データ数
- `feature_fraction`: 各イテレーションで使用する特徴量の割合
- `bagging_fraction`: 各イテレーションで使用するデータの割合
- `bagging_freq`: バギングの頻度
- `lambda_l1`, `lambda_l2`: L1/L2正則化パラメータ

#### チューニング手法
- **グリッドサーチ**: パラメータの組み合わせを網羅的に探索
- **ランダムサーチ**: ランダムにパラメータを選択して探索
- **ベイズ最適化**: 過去の結果を考慮して効率的に探索

## 5. システムアーキテクチャ

### 5.1 全体構成

```
[データ収集] → [データ前処理] → [特徴量エンジニアリング] → [モデル学習] → [予測] → [評価・可視化]
```

### 5.2 モジュール構成

1. **データ収集モジュール**
   - Webスクレイピングコンポーネント
   - データ保存コンポーネント

2. **データ前処理モジュール**
   - クリーニングコンポーネント
   - 正規化コンポーネント
   - 欠損値処理コンポーネント

3. **特徴量エンジニアリングモジュール**
   - 基本特徴量生成コンポーネント
   - 高度特徴量生成コンポーネント
   - 特徴量選択コンポーネント

4. **モデル学習モジュール**
   - モデル定義コンポーネント
   - 学習実行コンポーネント
   - ハイパーパラメータチューニングコンポーネント

5. **予測モジュール**
   - バッチ予測コンポーネント
   - リアルタイム予測コンポーネント

6. **評価・可視化モジュール**
   - 性能評価コンポーネント
   - 結果可視化コンポーネント
   - レポート生成コンポーネント

### 5.3 データフロー

1. netkeiba.comなどからレース情報、馬情報、騎手情報をスクレイピング
2. 収集したデータをデータベースに保存
3. データの前処理（欠損値処理、正規化など）
4. 特徴量エンジニアリング（基本特徴量、高度特徴量の生成）
5. モデルの学習（LightGBMなど）
6. 予測の実行と評価
7. 結果の可視化とレポート生成

### 5.4 技術スタック

- **言語**: Python 3.10+
- **データ処理**: pandas, numpy
- **機械学習**: scikit-learn, LightGBM, XGBoost
- **データベース**: SQLite（開発）, PostgreSQL（本番）
- **Webスクレイピング**: BeautifulSoup, Selenium
- **可視化**: matplotlib, seaborn, Plotly
- **Webフレームワーク**: Flask/FastAPI
- **フロントエンド**: HTML, CSS, JavaScript, Vue.js

## 6. 実装計画

### 6.1 フェーズ1: 基本モデル構築

1. 基本的なデータ収集スクリプトの実装
2. 基本的な特徴量エンジニアリングの実装
3. LightGBMによる基本モデルの構築
4. 基本的な評価指標の実装

### 6.2 フェーズ2: モデル改良

1. 高度な特徴量エンジニアリングの実装
2. ハイパーパラメータチューニングの実装
3. 複数モデルの比較実験
4. 競馬特有の評価指標の実装

### 6.3 フェーズ3: システム統合

1. データベース設計と実装
2. 定期的なデータ収集の自動化
3. モデル学習の自動化
4. 予測結果の保存と分析

### 6.4 フェーズ4: Webインターフェース開発

1. APIの設計と実装
2. フロントエンドの設計と実装
3. 可視化コンポーネントの実装
4. レポート生成機能の実装

## 7. リスクと対策

### 7.1 データ関連リスク

- **リスク**: データの欠損や不整合
- **対策**: 堅牢なデータ検証と前処理パイプラインの構築

- **リスク**: スクレイピングサイトの構造変更
- **対策**: 定期的なスクレイピングコードの検証と修正

### 7.2 モデル関連リスク

- **リスク**: 過学習
- **対策**: 適切な正則化とクロスバリデーション

- **リスク**: 予測精度の不安定性
- **対策**: アンサンブル手法の活用と継続的なモデル評価

### 7.3 システム関連リスク

- **リスク**: 処理時間の増大
- **対策**: 効率的なデータ処理とモデル最適化

- **リスク**: スケーラビリティの問題
- **対策**: モジュール化された設計と段階的なスケーリング計画

## 8. 結論

本設計では、LightGBMを中心とした競馬予測モデルのアーキテクチャを提案しました。教師あり学習の分類問題と回帰問題の両方のアプローチを検討し、特徴量エンジニアリング、モデル評価、システム構成について詳細に計画しました。

初期段階では複勝圏内予測（二値分類）と着順予測（多クラス分類）の両方を実装し、性能を比較します。特徴量エンジニアリングでは、馬、騎手、レースに関する基本特徴量に加え、時系列特徴量や相対的特徴量などの高度な特徴量を生成します。

モデル評価では、一般的な機械学習の評価指標に加え、競馬特有の評価指標（的中率、回収率など）を活用します。システムは段階的に実装し、最終的にはWebインターフェースを通じて予測結果を提供します。
